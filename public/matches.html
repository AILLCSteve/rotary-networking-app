<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Networking Matches</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ù Your Networking Matches</h1>
            <div id="memberInfo" class="member-info"></div>
        </div>

        <div class="section">
            <h2>üåü Your Top 3 Matches</h2>
            <p class="info">These are your highest-scored potential connections based on complementary needs and assets</p>

            <div class="action-bar">
                <button class="btn btn-primary" id="generateTop3">Generate My Top 3 Matches</button>
            </div>

            <div id="top3Progress" class="progress-status">
                <div class="progress-status-header">ü§ñ Generating Your Top 3 Matches...</div>
                <div class="progress-status-message" id="top3ProgressMessage">Initializing...</div>
                <div class="progress-status-bar">
                    <div class="progress-status-fill" id="top3ProgressFill" style="width: 0%"></div>
                </div>
            </div>

            <div id="top3Matches" class="matches-grid"></div>
        </div>

        <div class="section">
            <h2>üí° Explore More Connections</h2>
            <p class="info">Brainstorm opportunities with everyone who opted in (excludes your Top 3)</p>

            <div class="action-bar">
                <button class="btn btn-secondary" id="generateBrainstorm">Brainstorm with Everyone</button>
            </div>

            <div id="brainstormProgress" class="progress-status">
                <div class="progress-status-header">ü§ñ Generating Brainstorm Matches...</div>
                <div class="progress-status-message" id="brainstormProgressMessage">Initializing...</div>
                <div class="progress-status-bar">
                    <div class="progress-status-fill" id="brainstormProgressFill" style="width: 0%"></div>
                </div>
            </div>

            <div id="brainstormMatches" class="matches-grid"></div>
        </div>

        <!-- Intro Modal -->
        <div id="introModal" class="modal hidden">
            <div class="modal-content">
                <span class="close" id="closeModal">&times;</span>
                <h3>Introduction Starter</h3>
                <div id="modalContent"></div>
                <button class="btn btn-primary" id="markAcknowledged">Mark as Introduced</button>
            </div>
        </div>
    </div>

    <script>
        // Get member ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const memberId = urlParams.get('id');
        
        if (!memberId) {
            alert('No member ID provided. Please register first.');
            window.location.href = '/';
        }
        
        let currentIntroId = null;
        
        // Load member data and matches
        async function loadDashboard() {
            try {
                const response = await fetch(`/api/member/${memberId}`);
                const data = await response.json();
                
                // Display member info
                document.getElementById('memberInfo').innerHTML = `
                    <strong>${data.member.name}</strong> | ${data.member.org} | ${data.member.role}
                `;
                
                // Display top 3 matches
                displayMatches(data.top3, 'top3Matches');
                
                // Display brainstorm matches
                displayMatches(data.brainstorm, 'brainstormMatches');
                
            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }
        
        function displayMatches(matches, containerId) {
            const container = document.getElementById(containerId);

            if (!matches || matches.length === 0) {
                container.innerHTML = '<p class="no-matches">No matches generated yet. Click the button above to generate matches.</p>';
                return;
            }

            container.innerHTML = matches.map(match => {
                // Parse score breakdown if available
                let scoreBreakdownHTML = '';
                if (match.score_breakdown) {
                    try {
                        const scoreData = typeof match.score_breakdown === 'string'
                            ? JSON.parse(match.score_breakdown)
                            : match.score_breakdown;

                        // scoreData contains: { breakdown, fullBreakdown, summary }
                        const breakdown = scoreData.breakdown || scoreData; // fallback to old format
                        const summary = scoreData.summary;

                        scoreBreakdownHTML = `
                            <div class="score-breakdown">
                                <div class="score-header">
                                    <strong>Match Score: ${Math.round(match.score)}/100</strong>
                                    ${summary ? `<span class="grade-badge grade-${summary.grade.replace('+', 'plus')}">${summary.grade}</span>` : ''}
                                </div>
                                <div class="breakdown-details">
                                    ${breakdown.map(item => {
                                        const percentage = item.maxPoints > 0 ? (item.points / item.maxPoints) * 100 : 0;
                                        return `
                                        <div class="breakdown-item">
                                            <div class="breakdown-header">
                                                <span class="factor-name">${item.factor}</span>
                                                <span class="factor-score">${item.points}/${item.maxPoints} pts</span>
                                            </div>
                                            <div class="progress-bar">
                                                <div class="progress-fill" style="width: ${percentage}%"></div>
                                            </div>
                                            ${item.description ? `<div class="factor-description">${item.description}</div>` : ''}
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    } catch (e) {
                        console.error('Error parsing score breakdown:', e);
                        scoreBreakdownHTML = `<p class="match-score">Match Score: ${Math.round(match.score)}/100</p>`;
                    }
                } else {
                    scoreBreakdownHTML = match.score ? `<p class="match-score">Match Score: ${Math.round(match.score)}/100</p>` : '';
                }

                return `
                <div class="match-card ${match.status === 'acknowledged' ? 'acknowledged' : ''}" data-intro-id="${match.intro_id}">
                    <div class="match-header">
                        <h4>${match.name}</h4>
                        <span class="match-org">${match.org}</span>
                        ${match.status === 'acknowledged' ? '<span class="badge">‚úì Introduced</span>' : ''}
                    </div>
                    <div class="match-details">
                        <p class="match-role">${match.role} ‚Ä¢ ${match.city || 'Location not specified'}</p>
                        ${scoreBreakdownHTML}
                    </div>
                    <div class="match-rationale">
                        ${match.rationale_ops ? `
                            <div class="rationale-item">
                                <strong>Ops Rationale:</strong>
                                <p>${match.rationale_ops}</p>
                            </div>
                        ` : ''}
                        ${match.creative_angle ? `
                            <div class="rationale-item">
                                <strong>Creative Angle:</strong>
                                <p>${match.creative_angle}</p>
                            </div>
                        ` : ''}
                    </div>
                    <button class="btn btn-small intro-btn" data-intro-id="${match.intro_id}">
                        View Introduction Starter
                    </button>
                </div>
            `;
            }).join('');

            // Add event listeners to intro buttons
            document.querySelectorAll('.intro-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const introId = this.dataset.introId;
                    // Find the match data from the matches array
                    const match = matches.find(m => m.intro_id === introId);
                    console.log('Match found:', match);
                    console.log('intro_basis type:', typeof match?.intro_basis);
                    console.log('intro_basis value:', match?.intro_basis);
                    const introBasis = match ? (match.intro_basis || 'Start a conversation about how you can help each other.') : 'No introduction available.';
                    showIntro(introId, introBasis);
                });
            });
        }

        function escapeForAttribute(text) {
            return text.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showIntro(introId, introBasis) {
            currentIntroId = introId;

            // Handle if introBasis is an object or string
            let displayText = introBasis;
            if (typeof introBasis === 'object') {
                // If it's an object, stringify it nicely or extract text
                displayText = JSON.stringify(introBasis, null, 2);
            }

            // Replace newlines with <br> for better formatting
            displayText = displayText.replace(/\n/g, '<br>');

            document.getElementById('modalContent').innerHTML = `<div style="white-space: pre-wrap;">${displayText}</div>`;
            document.getElementById('introModal').classList.remove('hidden');
        }
        
        // Generate Top 3 with progress tracking
        document.getElementById('generateTop3').addEventListener('click', async () => {
            const btn = document.getElementById('generateTop3');
            const progressBox = document.getElementById('top3Progress');
            const progressMessage = document.getElementById('top3ProgressMessage');
            const progressFill = document.getElementById('top3ProgressFill');
            const matchesContainer = document.getElementById('top3Matches');

            // Disable button and clear previous results
            btn.disabled = true;
            matchesContainer.innerHTML = '';
            progressBox.classList.add('active');

            // Progress simulation - estimated 15-30 seconds for 3 matches
            let progress = 0;
            const progressSteps = [
                { progress: 10, message: 'Analyzing your profile...' },
                { progress: 25, message: 'Scoring all potential matches...' },
                { progress: 40, message: 'Selecting top 3 candidates...' },
                { progress: 55, message: 'Generating AI introduction for match 1/3...' },
                { progress: 70, message: 'Generating AI introduction for match 2/3...' },
                { progress: 85, message: 'Generating AI introduction for match 3/3...' },
                { progress: 95, message: 'Finalizing your matches...' }
            ];

            let stepIndex = 0;
            const progressInterval = setInterval(() => {
                if (stepIndex < progressSteps.length) {
                    const step = progressSteps[stepIndex];
                    progressFill.style.width = step.progress + '%';
                    progressMessage.textContent = step.message;
                    stepIndex++;
                }
            }, 3000); // Update every 3 seconds

            try {
                const response = await fetch(`/api/generate-top3/${memberId}`, {
                    method: 'POST'
                });
                const result = await response.json();

                clearInterval(progressInterval);

                if (result.success) {
                    progressFill.style.width = '100%';
                    progressMessage.textContent = `‚úÖ Generated ${result.count} top matches! Loading results...`;

                    // Wait a moment then load dashboard
                    setTimeout(() => {
                        progressBox.classList.remove('active');
                        loadDashboard();
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Failed to generate matches');
                }
            } catch (error) {
                clearInterval(progressInterval);
                progressMessage.textContent = '‚ùå Failed to generate matches: ' + error.message;
                progressFill.style.width = '0%';
                console.error(error);
                setTimeout(() => {
                    progressBox.classList.remove('active');
                }, 3000);
            } finally {
                btn.disabled = false;
            }
        });
        
        // Generate Brainstorm with progress tracking
        document.getElementById('generateBrainstorm').addEventListener('click', async () => {
            const btn = document.getElementById('generateBrainstorm');
            const progressBox = document.getElementById('brainstormProgress');
            const progressMessage = document.getElementById('brainstormProgressMessage');
            const progressFill = document.getElementById('brainstormProgressFill');
            const matchesContainer = document.getElementById('brainstormMatches');

            // Disable button and clear previous results
            btn.disabled = true;
            matchesContainer.innerHTML = '';
            progressBox.classList.add('active');

            // Progress simulation - estimated 1-3 minutes for 10-15 matches
            const progressSteps = [
                { progress: 5, message: 'Analyzing your profile...' },
                { progress: 15, message: 'Scoring all attendees...' },
                { progress: 25, message: 'Excluding your Top 3 matches...' },
                { progress: 35, message: 'Generating AI introductions (this may take 1-2 minutes)...' },
                { progress: 50, message: 'Processing matches 1-5...' },
                { progress: 65, message: 'Processing matches 6-10...' },
                { progress: 80, message: 'Processing final matches...' },
                { progress: 95, message: 'Finalizing all connections...' }
            ];

            let stepIndex = 0;
            const progressInterval = setInterval(() => {
                if (stepIndex < progressSteps.length) {
                    const step = progressSteps[stepIndex];
                    progressFill.style.width = step.progress + '%';
                    progressMessage.textContent = step.message;
                    stepIndex++;
                }
            }, 8000); // Update every 8 seconds (slower for longer process)

            try {
                const response = await fetch(`/api/generate-brainstorm/${memberId}`, {
                    method: 'POST'
                });
                const result = await response.json();

                clearInterval(progressInterval);

                if (result.success) {
                    progressFill.style.width = '100%';
                    progressMessage.textContent = `‚úÖ Generated ${result.count} potential connections! Loading results...`;

                    // Wait a moment then load dashboard
                    setTimeout(() => {
                        progressBox.classList.remove('active');
                        loadDashboard();
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Failed to generate brainstorm matches');
                }
            } catch (error) {
                clearInterval(progressInterval);
                progressMessage.textContent = '‚ùå Failed to generate brainstorm: ' + error.message;
                progressFill.style.width = '0%';
                console.error(error);
                setTimeout(() => {
                    progressBox.classList.remove('active');
                }, 3000);
            } finally {
                btn.disabled = false;
            }
        });
        
        // Modal controls
        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('introModal').classList.add('hidden');
        });
        
        document.getElementById('markAcknowledged').addEventListener('click', async () => {
            if (currentIntroId) {
                await fetch(`/api/acknowledge-intro/${currentIntroId}`, { method: 'POST' });
                document.getElementById('introModal').classList.add('hidden');
                loadDashboard();
            }
        });
        
        // Initial load
        loadDashboard();
        
        // Auto-refresh every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>
