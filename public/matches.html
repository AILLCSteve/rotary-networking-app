<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Networking Matches</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ù Your Networking Matches</h1>
            <div id="memberInfo" class="member-info"></div>
        </div>

        <div class="section">
            <h2>üåü Your Top 3 Matches</h2>
            <p class="info">These are your highest-scored potential connections based on complementary needs and assets</p>

            <div class="action-bar">
                <button class="btn btn-primary" id="generateTop3">Generate My Top 3 Matches</button>
            </div>

            <div id="top3Progress" class="progress-status">
                <div class="progress-status-header">ü§ñ Generating Your Top 3 Matches...</div>
                <div class="progress-status-message" id="top3ProgressMessage">Initializing...</div>
                <div class="progress-status-bar">
                    <div class="progress-status-fill" id="top3ProgressFill" style="width: 0%"></div>
                </div>
            </div>

            <div id="top3Matches" class="matches-grid"></div>
        </div>

        <div class="section">
            <h2>üí° Explore More Connections</h2>
            <p class="info">Brainstorm opportunities with everyone who opted in (excludes your Top 3)</p>

            <div class="action-bar">
                <button class="btn btn-secondary" id="generateBrainstorm">Brainstorm with Everyone</button>
            </div>

            <div id="brainstormProgress" class="progress-status">
                <div class="progress-status-header">ü§ñ Generating Brainstorm Matches...</div>
                <div class="progress-status-message" id="brainstormProgressMessage">Initializing...</div>
                <div class="progress-status-bar">
                    <div class="progress-status-fill" id="brainstormProgressFill" style="width: 0%"></div>
                </div>
            </div>

            <div id="brainstormMatches" class="matches-grid"></div>
        </div>

        <!-- Intro Modal -->
        <div id="introModal" class="modal hidden">
            <div class="modal-content">
                <span class="close" id="closeModal">&times;</span>
                <div id="modalContent"></div>
                <button class="btn btn-primary" id="markAcknowledged" style="margin-top: 2rem;">‚úì Mark as Introduced</button>
            </div>
        </div>
    </div>

    <script>
        // Get member ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const memberId = urlParams.get('id');
        
        if (!memberId) {
            alert('No member ID provided. Please register first.');
            window.location.href = '/';
        }
        
        let currentIntroId = null;
        
        // Load member data and matches
        async function loadDashboard() {
            try {
                const response = await fetch(`/api/member/${memberId}`);
                const data = await response.json();
                
                // Display member info
                document.getElementById('memberInfo').innerHTML = `
                    <strong>${data.member.name}</strong> | ${data.member.org} | ${data.member.role}
                `;
                
                // Display top 3 matches
                displayMatches(data.top3, 'top3Matches');
                
                // Display brainstorm matches
                displayMatches(data.brainstorm, 'brainstormMatches');
                
            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }
        
        function displayMatches(matches, containerId) {
            const container = document.getElementById(containerId);

            if (!matches || matches.length === 0) {
                container.innerHTML = '<p class="no-matches">No matches generated yet. Click the button above to generate matches.</p>';
                return;
            }

            container.innerHTML = matches.map(match => {
                // Parse score breakdown if available
                let scoreBreakdownHTML = '';
                if (match.score_breakdown) {
                    try {
                        const scoreData = typeof match.score_breakdown === 'string'
                            ? JSON.parse(match.score_breakdown)
                            : match.score_breakdown;

                        // scoreData contains: { breakdown, fullBreakdown, summary }
                        const breakdown = scoreData.breakdown || scoreData; // fallback to old format
                        const summary = scoreData.summary;

                        scoreBreakdownHTML = `
                            <div class="score-breakdown">
                                <div class="score-header">
                                    <strong>Match Score: ${Math.round(match.score)}/100</strong>
                                    ${summary ? `<span class="grade-badge grade-${summary.grade.replace('+', 'plus')}">${summary.grade}</span>` : ''}
                                </div>
                                <div class="breakdown-details">
                                    ${breakdown.map(item => {
                                        const percentage = item.maxPoints > 0 ? (item.points / item.maxPoints) * 100 : 0;
                                        return `
                                        <div class="breakdown-item">
                                            <div class="breakdown-header">
                                                <span class="factor-name">${item.factor}</span>
                                                <span class="factor-score">${item.points}/${item.maxPoints} pts</span>
                                            </div>
                                            <div class="progress-bar">
                                                <div class="progress-fill" style="width: ${percentage}%"></div>
                                            </div>
                                            ${item.description ? `<div class="factor-description">${item.description}</div>` : ''}
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    } catch (e) {
                        console.error('Error parsing score breakdown:', e);
                        scoreBreakdownHTML = `<p class="match-score">Match Score: ${Math.round(match.score)}/100</p>`;
                    }
                } else {
                    scoreBreakdownHTML = match.score ? `<p class="match-score">Match Score: ${Math.round(match.score)}/100</p>` : '';
                }

                return `
                <div class="match-card ${match.status === 'acknowledged' ? 'acknowledged' : ''}" data-intro-id="${match.intro_id}">
                    <div class="match-header">
                        <h4>${match.name}</h4>
                        <span class="match-org">${match.org}</span>
                        ${match.status === 'acknowledged' ? '<span class="badge">‚úì Introduced</span>' : ''}
                    </div>
                    <div class="match-details">
                        <p class="match-role">${match.role} ‚Ä¢ ${match.city || 'Location not specified'}</p>
                        ${scoreBreakdownHTML}
                    </div>
                    <div class="match-rationale">
                        ${match.rationale_ops ? `
                            <div class="rationale-item">
                                <strong>Why Connect:</strong>
                                <p>${match.rationale_ops}</p>
                            </div>
                        ` : ''}
                        ${match.creative_angle ? `
                            <div class="rationale-item">
                                <strong>Unique Opportunity:</strong>
                                <p>${match.creative_angle}</p>
                            </div>
                        ` : ''}
                    </div>
                    <button class="btn btn-small intro-btn" data-intro-id="${match.intro_id}">
                        View Conversation Starters ‚Üí
                    </button>
                </div>
            `;
            }).join('');

            // Add event listeners to intro buttons
            document.querySelectorAll('.intro-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const introId = this.dataset.introId;
                    // Find the match data from the matches array
                    const match = matches.find(m => m.intro_id === introId);
                    console.log('Match found:', match);
                    console.log('intro_basis type:', typeof match?.intro_basis);
                    console.log('intro_basis value:', match?.intro_basis);
                    const introBasis = match ? (match.intro_basis || 'Start a conversation about how you can help each other.') : 'No introduction available.';
                    showIntro(introId, introBasis);
                });
            });
        }

        function escapeForAttribute(text) {
            return text.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showIntro(introId, introBasis) {
            currentIntroId = introId;

            // Parse and format the intro content
            let formattedHTML = '';

            try {
                // introBasis contains numbered conversation approaches
                // Clean up any JSON-like formatting
                let cleanText = introBasis;

                if (typeof introBasis === 'object') {
                    cleanText = JSON.stringify(introBasis, null, 2);
                }

                // Remove JSON-like key/value formatting
                cleanText = cleanText.replace(/"(\w+)":\s*/g, ''); // Remove "key":
                cleanText = cleanText.replace(/[\{\}]/g, ''); // Remove braces
                cleanText = cleanText.replace(/^,/gm, ''); // Remove leading commas

                // Split by numbered approaches (Approach #1, Approach #2, Approach #3)
                const approaches = cleanText.split(/(Approach #\d+:)/);

                // Build formatted HTML
                let approachNumber = 0;
                formattedHTML = '<div class="intro-content">';
                formattedHTML += '<h4 style="margin-bottom: 1rem; color: #667eea;">üí° Conversation Starters</h4>';

                for (let i = 0; i < approaches.length; i++) {
                    const part = approaches[i].trim();
                    if (!part) continue;

                    if (part.match(/Approach #\d+:/)) {
                        approachNumber++;
                        formattedHTML += `<div class="approach-item" style="margin-bottom: 1.5rem;">`;
                        formattedHTML += `<div class="approach-number" style="background: #667eea; color: white; width: 30px; height: 30px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: 700; margin-bottom: 0.5rem;">${approachNumber}</div>`;
                    } else {
                        // Clean up the approach text
                        let cleanedApproach = part
                            .replace(/^\s*"/, '') // Remove leading quote
                            .replace(/"\s*$/, '') // Remove trailing quote
                            .replace(/\\"/g, '"') // Unescape quotes
                            .replace(/\n\n+/g, '\n') // Remove extra newlines
                            .trim();

                        formattedHTML += `<p style="line-height: 1.6; color: #333; margin-left: 0.5rem;">${cleanedApproach}</p>`;
                        formattedHTML += `</div>`;
                    }
                }

                formattedHTML += '</div>';

            } catch (error) {
                console.error('Error formatting intro:', error);
                // Fallback to simple display
                formattedHTML = `<div style="white-space: pre-wrap; line-height: 1.6;">${introBasis}</div>`;
            }

            document.getElementById('modalContent').innerHTML = formattedHTML;
            document.getElementById('introModal').classList.remove('hidden');
        }
        
        // Generate Top 3 with progress tracking
        document.getElementById('generateTop3').addEventListener('click', async () => {
            const btn = document.getElementById('generateTop3');
            const progressBox = document.getElementById('top3Progress');
            const progressMessage = document.getElementById('top3ProgressMessage');
            const progressFill = document.getElementById('top3ProgressFill');
            const matchesContainer = document.getElementById('top3Matches');

            // Disable button and clear previous results
            btn.disabled = true;
            matchesContainer.innerHTML = '';
            progressBox.classList.add('active');

            // Progress simulation - estimated 30-60 seconds for 3 matches (3-stage research per match)
            let progress = 0;
            const progressSteps = [
                { progress: 8, message: 'Analyzing your profile...' },
                { progress: 16, message: 'Scoring all potential matches...' },
                { progress: 24, message: 'Selecting top 3 candidates...' },
                { progress: 32, message: 'Match 1/3: Researching industry trends & market dynamics...' },
                { progress: 40, message: 'Match 1/3: Deep-diving into company & individual backgrounds...' },
                { progress: 48, message: 'Match 1/3: Synthesizing strategic introduction...' },
                { progress: 56, message: 'Match 2/3: Researching industry trends & market dynamics...' },
                { progress: 64, message: 'Match 2/3: Deep-diving into company & individual backgrounds...' },
                { progress: 72, message: 'Match 2/3: Synthesizing strategic introduction...' },
                { progress: 80, message: 'Match 3/3: Researching industry trends & market dynamics...' },
                { progress: 88, message: 'Match 3/3: Deep-diving into company & individual backgrounds...' },
                { progress: 94, message: 'Match 3/3: Synthesizing strategic introduction...' },
                { progress: 98, message: 'Finalizing your research-backed matches...' }
            ];

            let stepIndex = 0;
            const progressInterval = setInterval(() => {
                if (stepIndex < progressSteps.length) {
                    const step = progressSteps[stepIndex];
                    progressFill.style.width = step.progress + '%';
                    progressMessage.textContent = step.message;
                    stepIndex++;
                }
            }, 4000); // Update every 4 seconds (3-stage research is more thorough)

            try {
                const response = await fetch(`/api/generate-top3/${memberId}`, {
                    method: 'POST'
                });
                const result = await response.json();

                clearInterval(progressInterval);

                if (result.success) {
                    progressFill.style.width = '100%';
                    progressMessage.textContent = `‚úÖ Generated ${result.count} top matches! Loading results...`;

                    // Wait a moment then load dashboard
                    setTimeout(() => {
                        progressBox.classList.remove('active');
                        loadDashboard();
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Failed to generate matches');
                }
            } catch (error) {
                clearInterval(progressInterval);
                progressMessage.textContent = '‚ùå Failed to generate matches: ' + error.message;
                progressFill.style.width = '0%';
                console.error(error);
                setTimeout(() => {
                    progressBox.classList.remove('active');
                }, 3000);
            } finally {
                btn.disabled = false;
            }
        });
        
        // Generate Brainstorm with progress tracking
        document.getElementById('generateBrainstorm').addEventListener('click', async () => {
            const btn = document.getElementById('generateBrainstorm');
            const progressBox = document.getElementById('brainstormProgress');
            const progressMessage = document.getElementById('brainstormProgressMessage');
            const progressFill = document.getElementById('brainstormProgressFill');
            const matchesContainer = document.getElementById('brainstormMatches');

            // Disable button and clear previous results
            btn.disabled = true;
            matchesContainer.innerHTML = '';
            progressBox.classList.add('active');

            // Progress simulation - estimated 2-4 minutes for 10-20 matches (3-stage research per match)
            const progressSteps = [
                { progress: 3, message: 'Analyzing your profile...' },
                { progress: 6, message: 'Scoring all attendees...' },
                { progress: 9, message: 'Excluding your Top 3 matches...' },
                { progress: 12, message: 'Deep research mode activated - this will take 2-4 minutes...' },
                { progress: 20, message: 'Researching industry trends for matches 1-5...' },
                { progress: 28, message: 'Deep-diving into companies & backgrounds (matches 1-5)...' },
                { progress: 36, message: 'Synthesizing strategic introductions (matches 1-5)...' },
                { progress: 44, message: 'Researching industry trends for matches 6-10...' },
                { progress: 52, message: 'Deep-diving into companies & backgrounds (matches 6-10)...' },
                { progress: 60, message: 'Synthesizing strategic introductions (matches 6-10)...' },
                { progress: 68, message: 'Researching industry trends for matches 11-15...' },
                { progress: 76, message: 'Deep-diving into companies & backgrounds (matches 11-15)...' },
                { progress: 84, message: 'Synthesizing strategic introductions (matches 11-15)...' },
                { progress: 92, message: 'Processing final matches with peripheral opportunity analysis...' },
                { progress: 98, message: 'Finalizing all research-backed connections...' }
            ];

            let stepIndex = 0;
            const progressInterval = setInterval(() => {
                if (stepIndex < progressSteps.length) {
                    const step = progressSteps[stepIndex];
                    progressFill.style.width = step.progress + '%';
                    progressMessage.textContent = step.message;
                    stepIndex++;
                }
            }, 10000); // Update every 10 seconds (3-stage research is comprehensive)

            try {
                const response = await fetch(`/api/generate-brainstorm/${memberId}`, {
                    method: 'POST'
                });
                const result = await response.json();

                clearInterval(progressInterval);

                if (result.success) {
                    progressFill.style.width = '100%';
                    progressMessage.textContent = `‚úÖ Generated ${result.count} potential connections! Loading results...`;

                    // Wait a moment then load dashboard
                    setTimeout(() => {
                        progressBox.classList.remove('active');
                        loadDashboard();
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Failed to generate brainstorm matches');
                }
            } catch (error) {
                clearInterval(progressInterval);
                progressMessage.textContent = '‚ùå Failed to generate brainstorm: ' + error.message;
                progressFill.style.width = '0%';
                console.error(error);
                setTimeout(() => {
                    progressBox.classList.remove('active');
                }, 3000);
            } finally {
                btn.disabled = false;
            }
        });
        
        // Modal controls
        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('introModal').classList.add('hidden');
        });
        
        document.getElementById('markAcknowledged').addEventListener('click', async () => {
            if (currentIntroId) {
                await fetch(`/api/acknowledge-intro/${currentIntroId}`, { method: 'POST' });
                document.getElementById('introModal').classList.add('hidden');
                loadDashboard();
            }
        });
        
        // Initial load
        loadDashboard();
        
        // Auto-refresh every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>
